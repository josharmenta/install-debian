- name: Prepare CTMS directory
  gather_facts: true
  hosts: all
  become: true
  vars:
    xms: "2048m"
    xmx: "4096m"
    xss: "512k"
    perm: "256m"
  tasks:
    - name: Create /ctsms
      ansible.builtin.file:
        path: /ctsms/
        state: directory
        mode: '0755'

    - name: Remove /ctsms/bulk_processor
      ansible.builtin.file:
        path: /ctsms/bulk_processor/
        state: absent

    - name: Template clearcache to /ctsms/clearcache.sh
      ansible.builtin.template:
        src:  ../templates/shell/clearcache.sh.j2
        dest: /ctsms/clearcache.sh
        owner: ctsms
        group: ctsms
        mode: '0755'

    - name: Copy config-default to /ctsms/config-default/
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../config-default/"
        dest: /ctsms/config-default/
        owner: ctsms
        group: ctsms
        mode: '0755'
      delegate_to: "{{ inventory_hostname }}"

    - name: Write dbtool.sh
      ansible.builtin.copy:
        dest: /ctsms/dbtool.sh
        owner: ctsms
        group: ctsms
        mode: '0755'
        content: |
          #!/bin/bash
          CTSMS_PROPERTIES=${CTSMS_PROPERTIES:-/ctsms/properties}
          CTSMS_JAVA=${CTSMS_JAVA:-/ctsms/java}
          CATALINA_BASE=${CATALINA_BASE:-/opt/tomcat9}
          java -DCTSMS_PROPERTIES="$CTSMS_PROPERTIES" -DCTSMS_JAVA="$CTSMS_JAVA" -Dfile.encoding=Cp1252 -Djava.awt.headless=true --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED -Xms{{ xms }} -Xmx{{ xmx }} -Xss{{ xss }} -XX:+UseParallelGC -XX:MaxGCPauseMillis=1500 -XX:GCTimeRatio=9 -XX:ReservedCodeCacheSize={{ perm }} -classpath $CATALINA_BASE/webapps/ROOT/WEB-INF/lib/ctsms-core-1.8.1.jar:$CATALINA_BASE/webapps/ROOT/WEB-INF/lib/* org.phoenixctms.ctsms.executable.DBTool $*

    - name: Copy master-data to /ctsms/master_data/
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../master-data/"
        dest: /ctsms/master_data/
        owner: ctsms
        group: ctsms
        mode: '0755'
      delegate_to: "{{ inventory_hostname }}"

    - name: Recursively change ownership of /ctsms/
      ansible.builtin.file:
        path: /ctsms/
        state: directory
        recurse: yes
        owner: ctsms
        group: ctsms
        mode: '0755'

    - name: Recursively change ownership of /ctsms/external_files
      ansible.builtin.file:
        path: /ctsms/external_files
        state: directory
        recurse: yes
        owner: ctsms
        group: ctsms
        mode: '0755'

    - name: Template update to /ctsms/update
      ansible.builtin.template:
        src: ../templates/update.j2
        dest: /ctsms/update.sh
        owner: ctsms
        group: ctsms
        mode: '0755'
