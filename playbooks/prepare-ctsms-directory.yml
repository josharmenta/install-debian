- name: Prepare CTMS directory
  gather_facts: true
  hosts: all
  become: true
  vars:
    tag: "1.8.1"  # Replace with your actual tag or pass in as extra var
    xms: "2048m"
    xmx: "4096m"
    xss: "512k"
    perm: "256m"
    dest_dir: "/ctsms"
    archive_path: "/ctsms/config.tar.gz"
    download_url: "https://github.com/phoenixctms/config-default/archive/{{ tag }}.tar.gz"

  tasks:
    - name: Create /ctsms
      ansible.builtin.file:
        path: /ctsms/
        state: directory
        mode: '0755'

    - name: Remove /ctsms/bulk_processor
      ansible.builtin.file:
        path: /ctsms/bulk_processor/
        state: absent

    - name: Template clearcache to /ctsms/clearcache.sh
      ansible.builtin.template:
        src:  ../templates/shell/clearcache.sh.j2
        dest: /ctsms/clearcache.sh
        owner: ctsms
        group: ctsms
        mode: '0755'

    - name: Download config tarball
      get_url:
        url: "{{ download_url }}"
        dest: "{{ archive_path }}"
        validate_certs: no
        headers:
          Accept: "application/octet-stream"
        force: yes

    - name: Extract config tarball
      unarchive:
        src: "{{ archive_path }}"
        dest: "{{ dest_dir }}"
        remote_src: yes
        extra_opts:
          - "--strip-components=1"

    - name: Remove config tarball
      file:
        path: "{{ archive_path }}"
        state: absent

    - name: Template ctsms-applicationcontext.properties to "/ctsms/properties/ctsms-applicationcontext.properties
      ansible.builtin.template:
        src: ../templates/properties/ctsms-applicationcontext.properties.j2
        dest: "/ctsms/properties/ctsms-applicationcontext.properties"

    - name: Template ctsms-cv-pdf-settings.properties to "/ctsms/properties/ctsms-cv-pdf-settings.properties
      ansible.builtin.template:
        src: ../templates/properties/ctsms-cv-pdf-settings.properties.j2
        dest: "/ctsms/properties/ctsms-cv-pdf-settings.properties"

    - name: Template ctsms-dbtool.properties to "/ctsms/properties/ctsms-dbtool.properties
      ansible.builtin.template:
        src: ../templates/properties/ctsms-dbtool.properties.j2
        dest: "/ctsms/properties/ctsms-dbtool.properties"

    - name: Template ctsms-departments.properties to "/ctsms/properties/ctsms-departments.properties
      ansible.builtin.template:
        src: ../templates/properties/ctsms-departments.properties.j2
        dest: "/ctsms/properties/ctsms-departments.properties"

    - name: Template ctsms-departments_de.properties to "/ctsms/properties/ctsms-departments_de.properties
      ansible.builtin.template:
        src: ../templates/properties/ctsms-departments_de.properties.j2
        dest: "/ctsms/properties/ctsms-departments_de.properties"

    - name: Template ctsms-visitschedule-excel-settings.properties to "/ctsms/properties/ctsms-visitschedule-excel-settings.properties
      ansible.builtin.template:
        src: ../templates/properties/ctsms-visitschedule-excel-settings.properties.j2
        dest: "/ctsms/properties/ctsms-visitschedule-excel-settings.properties"

    - name: Write dbtool.sh
      ansible.builtin.copy:
        dest: /ctsms/dbtool.sh
        owner: ctsms
        group: ctsms
        mode: '0755'
        content: |
          #!/bin/bash
          CTSMS_PROPERTIES=${CTSMS_PROPERTIES:-/ctsms/properties}
          CTSMS_JAVA=${CTSMS_JAVA:-/ctsms/java}
          CATALINA_BASE=${CATALINA_BASE:-/opt/tomcat9}
          java -DCTSMS_PROPERTIES="$CTSMS_PROPERTIES" -DCTSMS_JAVA="$CTSMS_JAVA" -Dfile.encoding=Cp1252 -Djava.awt.headless=true --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED -Xms{{ xms }} -Xmx{{ xmx }} -Xss{{ xss }} -XX:+UseParallelGC -XX:MaxGCPauseMillis=1500 -XX:GCTimeRatio=9 -XX:ReservedCodeCacheSize={{ perm }} -classpath $CATALINA_BASE/webapps/ROOT/WEB-INF/lib/ctsms-core-1.8.1.jar:$CATALINA_BASE/webapps/ROOT/WEB-INF/lib/* org.phoenixctms.ctsms.executable.DBTool $*

    - name: Clone master-data repository to /ctsms/master_data
      ansible.builtin.git:
        repo: 'https://github.com/phoenixctms/master-data.git'
        dest: /ctsms/master_data

    - name: Recursively change ownership of /ctsms/
      ansible.builtin.file:
        path: /ctsms/
        state: directory
        recurse: yes
        owner: ctsms
        group: ctsms
        mode: '0755'

    - name: Recursively change ownership of /ctsms/external_files
      ansible.builtin.file:
        path: /ctsms/external_files
        state: directory
        recurse: yes
        owner: ctsms
        group: ctsms
        mode: '0755'

    - name: Template update to /ctsms/update
      ansible.builtin.template:
        src: ../templates/update.j2
        dest: /ctsms/update.sh
        owner: ctsms
        group: ctsms
        mode: '0755'
